@page "/settings"
@using BlazorApp.Shared
@using BlazorApp.Client.Services
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.Icons.Regular
@using Regular = Microsoft.FluentUI.AspNetCore.Components.Icons.Regular

@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Settings</PageTitle>

<h1>Settings</h1>

<p>Manage your application settings and data import/export options.</p>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Data Management</h5>
            </div>
            <div class="card-body">
                <p>Export your tracked items or import data from a file.</p>
                <div class="d-flex gap-2">
                    <BlazorApp.Client.Components.Export />
                    <a href="/import" class="btn btn-success">Import Data</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Notification Configuration</h5>
            </div>
            <div class="card-body">
                <p>Configure notification settings for your tracked items.</p>
                
                @if (NotificationSupported)
                {
                    <div class="notification-status mb-3">
                        @if (NotificationPermission == "granted")
                        {
                            <div class="d-flex align-items-center mb-2">
                                <FluentIcon Value="@(new Regular.Size24.CheckmarkCircle())" Color="@Color.Success" />
                                <span class="ms-2">Notifications enabled</span>
                            </div>
                            <p class="text-muted small">You will receive reminders when it's time to take your medication.</p>
                        }
                        else if (NotificationPermission == "denied")
                        {
                            <div class="d-flex align-items-center mb-2">
                                <FluentIcon Value="@(new Regular.Size24.AlertOff())" Color="@Color.Warning" />
                                <span class="ms-2">Notifications denied</span>
                            </div>
                            <p class="text-muted small">Check browser settings to enable notifications for this site.</p>
                        }
                        else if (NotificationPermission != "unsupported")
                        {
                            <FluentButton Appearance="Appearance.Outline" OnClick="@(async () => await RequestNotificationPermission())">
                                <FluentIcon Value="@(new Regular.Size24.Alert())" />
                                Enable notifications
                            </FluentButton>
                            <p class="text-muted small mt-2">Enable notifications to receive reminders for your tracked items with intervals.</p>
                        }
                    </div>
                }
                else
                {
                    <div class="d-flex align-items-center mb-2">
                        <FluentIcon Value="@(new Regular.Size24.Warning())" Color="@Color.Error" />
                        <span class="ms-2">Notifications not supported</span>
                    </div>
                    <p class="text-muted small">Your browser doesn't support notifications.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Notification Status</h5>
            </div>
            <div class="card-body">
                <p>Check your notification and background sync capabilities.</p>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Notifications</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Support:</span>
                        <span class="badge @GetStatusBadgeClass(NotificationSupported, "supported")">
                            @(NotificationSupported ? "Supported" : "Not Supported")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span>Permission:</span>
                        <span class="badge @GetPermissionBadgeClass(NotificationPermission)">
                            @GetPermissionDisplayText(NotificationPermission)
                        </span>
                    </div>
                </div>

                <div class="mb-3">
                    <h6 class="fw-bold">Background Sync</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Support:</span>
                        <span class="badge @GetStatusBadgeClass(BackgroundSyncSupported, "supported")">
                            @(BackgroundSyncSupported ? "Supported" : "Not Supported")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span>Permission:</span>
                        <span class="badge @GetPermissionBadgeClass(BackgroundSyncPermission)">
                            @GetPermissionDisplayText(BackgroundSyncPermission)
                        </span>
                    </div>
                </div>

                @if (IsLoading)
                {
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Checking status...</span>
                    </div>
                }
                else
                {
                    <button class="btn btn-primary btn-sm" @onclick="RefreshStatus">
                        <span class="bi bi-arrow-clockwise" aria-hidden="true"></span> Refresh Status
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="/" class="btn btn-secondary">
        <span class="bi bi-arrow-left" aria-hidden="true"></span> Back to Home
    </a>
</div>

@code {
    private bool NotificationSupported = false;
    private string NotificationPermission = "unknown";
    private bool BackgroundSyncSupported = false;
    private string BackgroundSyncPermission = "unknown";
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatus();
    }

    private async Task LoadStatus()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            NotificationSupported = await NotificationService.IsNotificationSupported();
            NotificationPermission = await NotificationService.GetPermissionStatus();
            BackgroundSyncSupported = await NotificationService.IsPeriodicBackgroundSyncSupported();
            BackgroundSyncPermission = await NotificationService.GetPBSPermissionStatus();
        }
        catch (Exception)
        {
            // Handle errors gracefully - keep default values
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshStatus()
    {
        await LoadStatus();
    }
    
    // Request notification permission when user clicks the button
    private async Task RequestNotificationPermission()
    {
        NotificationPermission = await NotificationService.RequestPermission();
        StateHasChanged();
    }

    private string GetStatusBadgeClass(bool isSupported, string feature)
    {
        return isSupported ? "bg-success" : "bg-danger";
    }

    private string GetPermissionBadgeClass(string permission)
    {
        return permission.ToLower() switch
        {
            "granted" => "bg-success",
            "denied" => "bg-danger",
            "default" or "prompt" => "bg-warning",
            "unsupported" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetPermissionDisplayText(string permission)
    {
        return permission.ToLower() switch
        {
            "granted" => "Granted",
            "denied" => "Denied",
            "default" => "Default",
            "prompt" => "Prompt",
            "unsupported" => "Unsupported",
            "unknown" => "Unknown",
            _ => permission
        };
    }
}